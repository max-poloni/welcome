<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beer Collect</title>
    <style>
        #betInput {
            display: inline-block;
            margin-right: 10px;
        }
        #beerEmoji {
            font-size: 24px;
        }
        #confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
<h2>Beer Collect</h2>
<div>
    <input type="number" id="betInput" min="1" max="100" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (1-100)">
    <span id="beerEmoji">üç∫</span>
</div>
<button id="playButton">Play</button>
<div id="result"></div>
<div id="confetti">üéâ</div>

<script>
    const betInput = document.getElementById('betInput');
    const playButton = document.getElementById('playButton');
    const resultDiv = document.getElementById('result');
    const confettiDiv = document.getElementById('confetti');

    //  Firebase, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const database = window.parent.firebase.database();

    playButton.addEventListener('click', playGame);

    function playGame() {
        console.log('Play button clicked'); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
        const betAmount = parseInt(betInput.value);
        if (betAmount < 1 || betAmount > 100 || isNaN(betAmount)) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ—Ç 1 –¥–æ 100');
            return;
        }

        const username = localStorage.getItem('currentUser') || '–ì–æ—Å—Ç—å';
        console.log('Current user:', username); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–π
        const userRef = database.ref('users/' + username);
        userRef.once('value').then((snapshot) => {
            let userData = snapshot.val();
            console.log('User data:', userData); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            if (userData && userData.balance >= betAmount) {
                playGameLogic(betAmount, username, userData.balance);
            } else {
                alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è —Å—Ç–∞–≤–∫–∏');
            }
        }).catch((error) => {
            console.error('Error fetching user data:', error);
        });
    }

    function playGameLogic(betAmount, username, currentBalance) {
        const gameName = 'Beer Collect';
        const currentDate = new Date().toISOString();
        const winCoefficient = Math.random() * 2 + 1; // –°–ª—É—á–∞–π–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç 1 –¥–æ 3
        const isWin = Math.random() < 0.5; // 50% —à–∞–Ω—Å –Ω–∞ –ø–æ–±–µ–¥—É
        const status = isWin ? 'Win' : 'Lose';
        const winAmount = isWin ? Math.floor(betAmount * winCoefficient) : 0;

        // –°–æ–∑–¥–∞–µ–º —Å–æ–±—ã—Ç–∏–µ "Bet"
        const betEvent = {
            gameName: gameName,
            username: username,
            dateTime: currentDate,
            betSum: betAmount,
            status: status,
            winSum: winAmount,
            winCoefficient: winCoefficient.toFixed(2)
        };

        console.log('Bet event:', betEvent); // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥

        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        database.ref('bets').push(betEvent);

        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const newBalance = currentBalance + winAmount - betAmount;
        database.ref('users/' + username).update({ balance: newBalance });

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        window.parent.document.getElementById('balance').innerHTML = `–ë–∞–ª–∞–Ω—Å: ${newBalance} üç∫`;

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (isWin) {
            resultDiv.innerHTML = `–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${winAmount} üç∫ (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: ${winCoefficient.toFixed(2)})`;
            showConfetti();
        } else {
            resultDiv.innerHTML = `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ ${betAmount} üç∫`;
        }
    }

    function showConfetti() {
        confettiDiv.style.display = 'block';
        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.innerText = 'üéâ';
            confetti.style.position = 'absolute';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.top = Math.random() * 100 + 'vh';
            confetti.style.fontSize = Math.random() * 20 + 10 + 'px';
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            confettiDiv.appendChild(confetti);
        }
        setTimeout(() => {
            confettiDiv.style.display = 'none';
            confettiDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
        }, 3000);
    }
</script>
</body>
</html>
